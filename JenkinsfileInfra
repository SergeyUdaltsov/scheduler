
pipeline {
    agent any
    parameters {
        choice(name: 'ENV', choices: ['dev', 'prod'])
        choice(name: 'REGION', choices: ['eu-central-1', 'us-east-1'])
    }
    stages {
        stage('Infrastructure deployment') {
            steps {
                script {
                    CONFIG = readYaml file: 'config.yml'
                    withAWS(roleAccount:"${CONFIG[params.ENV].awsAccount}", region:"$params.REGION") {
                        s3Upload(file:'infrastructure/substacks', bucket:"${CONFIG[params.ENV].deploymentBucket}")
                        cfnUpdate(stack:'my-stack', params:['DeploymentBucketUrl': "${CONFIG[params.ENV].deploymentBucket}"], file:'infrastructure/parentStack.yml')
                    }
                }
            }
        }
    }
}