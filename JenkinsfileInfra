
pipeline {
    agent any
    parameters {
        choice(name: 'ENV', choices: ['dev', 'prod'])
        choice(name: 'REGION', choices: ['eu-central-1', 'us-east-1'])
    }
    stages {
        stage('Infrastructure deployment') {
            steps {
                script {
                    CONFIG = readYaml file: 'config.yml'
                    withAWS(roleAccount:'${CONFIG[params.ENV].awsAccount}', region:'eu-central-1', role:'${CONFIG[params.ENV].jenkinsRole}') {
                        s3Upload(file:'substacks', bucket:'${CONFIG[params.ENV].deploymentBucket}', path:'infrastructure/')
                        cfnUpdate(stack:'my-stack', params:['DeploymentBucketUrl': '${CONFIG[params.ENV].deploymentBucket}'], file:'parentStack.yml')
                    }
                }
            }
        }
    }
}